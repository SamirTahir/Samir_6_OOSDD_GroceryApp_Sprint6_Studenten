<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Grocery.App.Views.GroceryListItemsView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:viewmodels="clr-namespace:Grocery.App.ViewModels"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:models="clr-namespace:Grocery.Core.Models;assembly=Grocery.Core"
    xmlns:behaviors="clr-namespace:Grocery.App.Behaviors"
    x:DataType="viewmodels:GroceryListItemsViewModel"
    x:Name="ThisPage"
    Title="{Binding GroceryList.Name}">

    <ContentPage.Behaviors>
        <!-- Adds/removes the admin ToolbarItem based on IsAdmin -->
        <behaviors:AdminToolbarItemBehavior />
    </ContentPage.Behaviors>

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Change color" Command="{Binding ChangeColorCommand}" />
        <ToolbarItem Text="Share" Command="{Binding ShareGroceryListCommand}" />
        <!-- Removed static admin item; now injected by behavior -->
    </ContentPage.ToolbarItems>

    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="16">

            <!-- Header with list name and color -->
            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12" VerticalOptions="Center">
                <BoxView WidthRequest="24" HeightRequest="24" CornerRadius="4" Color="{Binding GroceryList.Color}" />
                <Label Grid.Column="1" Text="{Binding GroceryList.Name}" FontSize="20" VerticalTextAlignment="Center" />
            </Grid>

            <!-- Two-column layout (left: current items, right: search/add products) -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="4*"/>
                    <ColumnDefinition Width="2*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="30"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Current items -->
                <VerticalStackLayout Grid.Row="1" Grid.Column="0" Spacing="8">
                    <!-- Current items -->
                    <Label Text="My Items" FontAttributes="Bold" />
                    <CollectionView ItemsSource="{Binding MyGroceryListItems}" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:GroceryListItem" xmlns:models="clr-namespace:Grocery.Core.Models;assembly=Grocery.Core">
                                <Grid Padding="8" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
                                    <VerticalStackLayout>
                                        <Label Text="{Binding Product.Name}" FontAttributes="Bold" />
                                        <Label Text="{Binding Amount, StringFormat='Qty: {0}'}" />
                                    </VerticalStackLayout>

                                    <Button Grid.Column="1"
                                            Text="-"
                                            WidthRequest="40"
                                            Command="{Binding BindingContext.DecreaseAmountCommand, Source={x:Reference ThisPage}}"
                                            CommandParameter="{Binding Product.Id}" />

                                    <Button Grid.Column="2"
                                            Text="+"
                                            WidthRequest="40"
                                            Command="{Binding BindingContext.IncreaseAmountCommand, Source={x:Reference ThisPage}}"
                                            CommandParameter="{Binding Product.Id}" />
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!-- Available products with search (same place as ProductCategoriesView: right column) -->
                <Border Grid.Row="1" Grid.Column="1" Stroke="#C49B33" StrokeThickness="4" Padding="5" Margin="5"
                        HorizontalOptions="Center" WidthRequest="420">
                    <VerticalStackLayout Spacing="8">
                        <SearchBar x:Name="searchBar"
                                   HorizontalOptions="Fill"
                                   SearchCommand="{Binding PerformSearchCommand}"
                                   SearchCommandParameter="{Binding Text, Source={x:Reference searchBar}}"/>
                        <CollectionView ItemsSource="{Binding AvailableProducts}" Margin="5" HorizontalOptions="Fill"
                                        SelectionMode="Single"
                                        SelectionChangedCommand="{Binding AddProductCommand}"
                                        SelectionChangedCommandParameter="{Binding Source={RelativeSource Self}, Path=SelectedItem}">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Vertical" ItemSpacing="10" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:Product">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="3*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Label Grid.Column="0" Text="{Binding Name}" VerticalOptions="Center"/>
                                        <Label Grid.Column="1" Text="{Binding Stock}" VerticalOptions="Center" HorizontalOptions="End" Margin="0,0,10,0"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                            <CollectionView.EmptyView>
                                <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center">
                                    <Label Text="Er zijn geen producten meer om toe te voegen" FontAttributes="Bold" HorizontalTextAlignment="Center"/>
                                </VerticalStackLayout>
                            </CollectionView.EmptyView>
                        </CollectionView>
                    </VerticalStackLayout>
                </Border>
            </Grid>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>