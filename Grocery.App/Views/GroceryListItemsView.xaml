<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Grocery.App.Views.GroceryListItemsView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:viewmodels="clr-namespace:Grocery.App.ViewModels"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:models="clr-namespace:Grocery.Core.Models;assembly=Grocery.Core"
    x:DataType="viewmodels:GroceryListItemsViewModel"
    x:Name="ThisPage"
    Title="{Binding GroceryList.Name}">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Change color" Command="{Binding ChangeColorCommand}" />
        <ToolbarItem Text="Share" Command="{Binding ShareGroceryListCommand}" />
    </ContentPage.ToolbarItems>

    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="16">

            <!-- Header with list name and color -->
            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12" VerticalOptions="Center">
                <BoxView WidthRequest="24" HeightRequest="24" CornerRadius="4" Color="{Binding GroceryList.Color}" />
                <Label Grid.Column="1" Text="{Binding GroceryList.Name}" FontSize="20" VerticalTextAlignment="Center" />
            </Grid>

            <!-- Current items -->
            <Label Text="My Items" FontAttributes="Bold" />
            <CollectionView ItemsSource="{Binding MyGroceryListItems}" SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:GroceryListItem" xmlns:models="clr-namespace:Grocery.Core.Models;assembly=Grocery.Core">
                        <Grid Padding="8" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
                            <VerticalStackLayout>
                                <Label Text="{Binding Product.Name}" FontAttributes="Bold" />
                                <Label Text="{Binding Amount, StringFormat='Qty: {0}'}" />
                            </VerticalStackLayout>

                            <Button Grid.Column="1"
                                    Text="-"
                                    WidthRequest="40"
                                    Command="{Binding BindingContext.DecreaseAmountCommand, Source={x:Reference ThisPage}}"
                                    CommandParameter="{Binding Product.Id}" />

                            <Button Grid.Column="2"
                                    Text="+"
                                    WidthRequest="40"
                                    Command="{Binding BindingContext.IncreaseAmountCommand, Source={x:Reference ThisPage}}"
                                    CommandParameter="{Binding Product.Id}" />
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Available products with search -->
            <Label Text="Add Products" FontAttributes="Bold" Margin="0,16,0,0" />

            <SearchBar Placeholder="Search products...">
                <SearchBar.Behaviors>
                    <toolkit:EventToCommandBehavior
                        EventName="TextChanged"
                        Command="{Binding PerformSearchCommand}"
                        EventArgsConverter="{StaticResource TextChangedEventArgsConverter}" />
                </SearchBar.Behaviors>
            </SearchBar>

            <CollectionView ItemsSource="{Binding AvailableProducts}" SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Product" xmlns:models="clr-namespace:Grocery.Core.Models;assembly=Grocery.Core">
                        <Grid Padding="8" ColumnDefinitions="*,Auto" ColumnSpacing="8">
                            <VerticalStackLayout>
                                <Label Text="{Binding Name}" FontAttributes="Bold" />
                                <Label Text="{Binding Stock, StringFormat='Stock: {0}'}" />
                            </VerticalStackLayout>

                            <Button Grid.Column="1"
                                    Text="Add"
                                    Command="{Binding BindingContext.AddProductCommand, Source={x:Reference ThisPage}}"
                                    CommandParameter="{Binding .}" />
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>